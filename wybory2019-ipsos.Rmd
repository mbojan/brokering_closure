---
title: "Wybory 2019 - IPSOS"
author: "@mbojan"
editor_options: 
  chunk_output_type: console
---


```{r setup}
library(tidyverse)
library(rvest)

options(
  tibble.print_min = Inf
)
```


# Dane

## Wybory 2019


Dane IPSOSa dla TVN24:

```{r download-ipsos}
# d <- jsonlite::fromJSON("~/Downloads/ipsos_results.json") %>%
wybory2019 <- jsonlite::fromJSON("https://wybory.online.tvwisla.com.pl/uploads/ipsos_results.json") %>%
  unlist() %>%
  enframe() %>%
  mutate(
    l = strsplit(name, "\\."),
    depth = map_int(l, length),
    what = map_chr(l, 1),
    path = map(l, head, -1),
    partia = map_chr(l, tail, 1)
  )
```

Ile czego:

```{r}
wybory2019 %>%
  distinct(what, depth) %>%
  knitr::kable()
```


## Sejm 2015

Wyniki wyborów parlamentarnych 2015^[Źródło: https://parlament2015.pkw.gov.pl/349_Wyniki_Sejm.html]

```{r wybory2015}
r <- xml2::read_html(
  "https://parlament2015.pkw.gov.pl/349_Wyniki_Sejm.html"
)

sejm2015 <- rvest::html_table(r, fill=TRUE)[[1]] %>%
  as_tibble(.name_repair = "unique") %>%
  filter(!is.na(Procent)) %>%
  select(-starts_with("...")) %>%
  mutate_at(
    c("Zdobyte głosy", "Procent"),
    ~ as.numeric(gsub("[^0-9.]", "", .))
  ) %>%
  mutate(
    komitet2019 = recode(
      `Nazwa komitetu`,
      "Komitet Wyborczy Prawo i Sprawiedliwość" = "PiS",
      "Komitet Wyborczy Platforma Obywatelska RP" = "PO",
      "Komitet Wyborczy Wyborców \"Kukiz'15\"" = "Kukiz",
      "Komitet Wyborczy Nowoczesna Ryszarda Petru" = "Nowoczesna",
      "Koalicyjny Komitet Wyborczy Zjednoczona Lewica SLD+TR+PPS+UP+Zieloni" = "Lewica",
      "Komitet Wyborczy Polskie Stronnictwo Ludowe" = "PSL",
      "Komitet Wyborczy KORWiN" = "Korwin",
      "Komitet Wyborczy Partia Razem" = "Razem",
      .default = "Inne partie i ugrupowania"
    )
  )


distinct(sejm2015, `Nazwa komitetu`)
```




# Joint probability of 2015 x 2019

```{r}
drow <- wybory2019 %>%
  filter(what == "SEJM_2015_row") %>%
  transmute(
    w2015 = map_chr(path, 2),
    w2019 = partia,
    pct = value
  )

tab <- with(drow, tapply(pct, list(w2015, w2019), identity)) / 100
rowSums(tab)

dcol <- wybory2019 %>%
  filter(what == "SEJM_2015_col") %>%
  transmute(
    w2015 = map_chr(path, 2),
    w2019 = partia,
    pct = value
  ) %>%
  arrange(w2019, w2015)
tab2 <- with(dcol, tapply(pct, list(w2015, w2019), identity)) / 100
colSums(tab2)

# P(a|b)
# P(2019 | 2015)
pab <- tab / 100

# P(b|a0)
# P(2015 | 2019 = PIS)
pba0 <- tab2[,"PIS"] / 100
sum(pba0)

# P(a0|b)
# P(2019=PiS | 2015)
pa0b <- tab[,"PIS"] / 100

r <- pab * pba0 / pa0b
r <- r / sum(r)

jointp <- function(tab1, tab2, a0) {
  # P(a|b)
  # P(2019 | 2015)
  pab <- tab1 / 100
  
  # P(b|a0)
  # P(2015 | 2019 = PIS)
  pba0 <- tab2[,a0] / 100
  sum(pba0)
  
  # P(a0|b)
  # P(2019=PiS | 2015)
  pa0b <- tab1[,a0] / 100
  r <- pab * pba0 / pa0b
  r / sum(r)
}

l <- lapply(
  colnames(tab1), 
  function(n) {
    jointp(tab1, tab2, n)
  }
)

lapply(l, function(x) x / sum(x)) %>%
  lapply(as.vector) %>%
  bind_cols() %>%
  as.data.frame() -> d
cor(d)
plot(d)
```

```{r}
p1 <- tab2 %*% t(tab)
colSums(p1)
```








# Przepływy: Sejm

```{r flows-sejm}
flows2019 <- wybory2019 %>%
  filter(what == "SEJM_2015_row") %>%
  transmute(
    w2015 = map_chr(path, 2),
    w2019 = partia,
    pct = value
  ) %>%
    left_join(
    sejm2015 %>%
      group_by(komitet2019) %>%
      summarise(glosy2015 = sum(`Zdobyte głosy`)),
    by=c("w2015"="komitet2019")
  ) %>%
  filter(!is.na(glosy2015)) %>%
  mutate(
    glosy = pct / 100 * glosy2015
  )
```

```{r flows-sejm-alluvial}
with(
  flows2019,
  alluvial::alluvial(
    select(flows2019, w2015, w2019),
    freq = glosy,
    col = match(w2019, unique(w2019))
  )
)
```

